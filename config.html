<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auto Post Discord Configuration</title>
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.0/dist/sweetalert2.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }
    .truncate {
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #pageTitle {
      text-align: center;
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
    }
    .btn-stop, .btn-success, .saveAuth {
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="container my-4" id="bodys">
    <h3 id="pageTitle">Auto Post Discord Configuration</h3>
  </div>
  <div class="card mb-4">
    <div class="card-body">
      <h4>Account Information: <span id="accountInfo"></span></h4>
      <h3>Config List</h3>
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="card-title">Configs</h4>
          <button class="btn btn-outline-primary" onclick="addConfig()">Add Config</button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Select</th>
                  <th>Message</th>
                  <th>Server</th>
                  <th>Channel</th>
                  <th>Delay (s)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="configTableBody">
                <!-- Configs will be dynamically added here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Logs -->
      <h3>Logs</h3>
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="card-title">Log Entries</h4>
          <button id="clearLogsBtn" class="btn btn-secondary">Clear Logs</button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Server</th>
                  <th>Channel</th>
                  <th>Delay (s)</th>
                  <th>Response</th>
                </tr>
              </thead>
              <tbody id="logTableBody">
                <!-- Logs will be dynamically added here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Start/Stop Buttons in one row -->
      <div class="d-flex align-items-center gap-2" style="margin-top: 1.5rem;">
        <button id="startBtn" class="btn btn-success" onclick="handleStartClick()">Start</button>
        <button id="stopBtn" class="btn btn-danger" onclick="handleStopClick()">Stop</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.0/dist/sweetalert2.all.min.js"></script>
  <script>
    let botConfigs = [];
    let currentAuthToken = "";
    // User manually selects configs to start/stop; this does not auto‑stop running channels
    let selectedConfigs = [];
    const showToast = Swal.mixin({
      toast: true,
      position: "top-end",
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.onmouseenter = Swal.stopTimer;
        toast.onmouseleave = Swal.resumeTimer;
      }
    });
    const confirmAction = (title, text) =>
      Swal.fire({
        title,
        text,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes"
      });
    document.getElementById("clearLogsBtn").addEventListener("click", clearLogs);
    async function addConfig() {
      const { value: config } = await Swal.fire({
        title: "Add Config",
        html: `
          <textarea id="message" class="swal2-textarea" placeholder="Message"></textarea>
          <input id="channelID" class="swal2-input" placeholder="Channel ID" type="number">
          <input id="delay" class="swal2-input" placeholder="Delay (s)" type="number">
        `,
        focusConfirm: false,
        preConfirm: () => validateConfig()
      });
      if (config) {
        // (Optional: You could fetch server/channel names here as well.)
        botConfigs.push(config);
        updateConfigTable();
        saveConfigs();
        showToast.fire({ icon: "success", title: "Config added" });
      }
    }
    async function editConfig(index) {
      const config = botConfigs[index];
      const { value: newConfig } = await Swal.fire({
        title: "Edit Config",
        html: `
          <textarea id="edit-message" class="swal2-textarea" placeholder="Message">${config.message}</textarea>
          <input id="edit-channelID" class="swal2-input" placeholder="Channel ID" type="number" value="${config.channelID}">
          <input id="edit-delay" class="swal2-input" placeholder="Delay (s)" type="number" value="${config.delay}">
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: "Save Changes",
        preConfirm: () => validateConfig("edit-")
      });
      if (newConfig) {
        botConfigs[index] = newConfig;
        updateConfigTable();
        saveConfigs();
        showToast.fire({ icon: "success", title: "Config updated" });
      }
    }
    function validateConfig(prefix = "") {
      const message = document.getElementById(prefix + "message").value.trim();
      const channelID = document.getElementById(prefix + "channelID").value.trim();
      const delaySeconds = parseInt(document.getElementById(prefix + "delay").value.trim(), 10);
      if (!message || !channelID || isNaN(delaySeconds)) {
        Swal.showValidationMessage("All fields are required");
        return false;
      }
      if (delaySeconds < 1) {
        Swal.showValidationMessage("Delay must be at least 1 second");
        return false;
      }
      return { message, channelID, delay: delaySeconds };
    }
    function deleteConfig(index) {
      confirmAction("Delete Config", "Are you sure?").then((result) => {
        if (result.isConfirmed) {
          botConfigs.splice(index, 1);
          updateConfigTable();
          saveConfigs();
          showToast.fire({ icon: "success", title: "Config deleted" });
        }
      });
    }
    // Toggle selection (manual – does not affect running auto‑post)
    function toggleConfigSelection(index, isSelected) {
      const config = botConfigs[index];
      if (isSelected) {
        if (!selectedConfigs.includes(config)) {
          selectedConfigs.push(config);
        }
      } else {
        selectedConfigs = selectedConfigs.filter(c => c !== config);
      }
      updateConfigTable();
    }
    function updateConfigTable() {
      const tbody = document.getElementById("configTableBody");
      tbody.innerHTML = "";
      botConfigs.forEach((config, index) => {
        const isSelected = selectedConfigs.includes(config);
        // (Status badge could be improved by showing server auto‑post state; here we leave it static.)
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <input type="checkbox" onchange="toggleConfigSelection(${index}, this.checked)" ${isSelected ? "checked" : ""}>
          </td>
          <td title="${config.message}">${truncateText(config.message, 20)}</td>
          <td>${config.serverName || "N/A"}</td>
          <td>${config.channelName || config.channelID}</td>
          <td>${config.delay}</td>
          <td>
            <button class="btn btn-info btn-sm me-2" onclick="editConfig(${index})">Edit</button>
            <button class="btn btn-danger btn-sm me-2" onclick="deleteConfig(${index})">
              <i class="fas fa-trash-alt"></i>
            </button>
            <span class="badge" id="status-${index}">Status</span>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    function truncateText(text, maxLength) {
      return text.length <= maxLength ? text : text.substr(0, maxLength - 3) + "...";
    }
    async function saveConfigs() {
      fetch(`/conf/${currentAuthToken}/save-configs`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ configs: botConfigs })
      })
      .then(r => r.json())
      .then(data => {
        if (!data.success) console.error("Failed to save configs");
      })
      .catch(err => console.error("Error:", err));
    }
    function saveAutoPostState(state) {
      fetch(`/conf/${currentAuthToken}/save-auto-post-state`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ state })
      })
      .then(r => r.json())
      .then(data => {
        if (!data.success) console.error("Failed to save auto-post state");
      })
      .catch(err => console.error("Error:", err));
    }
    async function loadConfigs() {
      try {
        const response = await fetch(`/conf/${currentAuthToken}/load-configs`);
        const data = await response.json();
        if (data.success) {
          botConfigs = data.configs || [];
          updateConfigTable();
          if (data.autoPostState === "started") {
            console.log("Server auto-post is active.");
          }
        } else {
          console.error("Failed to load configs:", data.message || "Unknown error");
        }
      } catch (err) {
        console.error("Error loading configs:", err);
      }
    }
    async function handleStartClick() {
      if (selectedConfigs.length === 0) {
        Swal.fire("Error", "Select at least one config to start", "error");
        return;
      }
      // Save configs then instruct server to start auto-post
      await saveConfigs();
      fetch(`/conf/${currentAuthToken}/save-auto-post-state`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ state: "started" })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast.fire({ icon: "success", title: "Auto post started (server side)" });
        }
      });
      // Clear manual selection after command
      selectedConfigs = [];
      updateConfigTable();
    }
    async function handleStopClick() {
      if (selectedConfigs.length === 0) {
        Swal.fire("Error", "Select at least one config to stop", "error");
        return;
      }
      fetch(`/conf/${currentAuthToken}/save-auto-post-state`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ state: "stopped" })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast.fire({ icon: "success", title: "Auto post stopped (server side)" });
        }
      });
      selectedConfigs = [];
      updateConfigTable();
    }
    const urlParts = window.location.pathname.split("/");
    currentAuthToken = urlParts[urlParts.length - 1];
    if (!currentAuthToken) {
      Swal.fire({
        icon: "error",
        title: "Invalid Auth Token",
        text: "Redirecting to main page...",
        timer: 2000,
        timerProgressBar: true,
      }).then(() => {
        window.location.href = "/";
      });
    } else {
      loadConfigs();
    }
  </script>
</body>
</html>